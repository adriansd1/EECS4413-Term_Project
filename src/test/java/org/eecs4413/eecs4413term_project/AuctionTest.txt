#!/bin/bash

# ==========================================
#  AUCTION SYSTEM E2E TEST SCRIPT
# ==========================================

BASE_URL="http://localhost:8080/api"
CONTENT_HEADER="Content-Type: application/json"

# Colors for output
GREEN='\033[0;32m'
RED='\033[0;31m'
NC='\033[0m' # No Color

echo -e "${GREEN}--- üöÄ Starting Auction System Test ---${NC}"

# ==========================================
# 1. AUTHENTICATION & USER SETUP
# ==========================================
echo " "
echo "--- Test 1: User Setup (Signup + Login) ---"

# --- ALICE ---
echo "1a. Creating & Logging in User 'Alice'..."
# 1. Signup
curl -s -X POST "$BASE_URL/auth/signup" \
  -H "$CONTENT_HEADER" \
  -d '{
    "username": "alice_test", "password": "StrongPass123",
    "firstName": "Alice", "lastName": "Wonder",
    "email": "alice_test@example.com", "shippingAddress": "123 Wonderland"
  }' > /dev/null

# 2. Signin to get Token
ALICE_RESP=$(curl -s -X POST "$BASE_URL/auth/signin" \
  -H "$CONTENT_HEADER" \
  -d '{ "username": "alice_test", "password": "StrongPass123" }')

# 3. Extract Token and ID
ALICE_TOKEN=$(echo $ALICE_RESP | jq -r '.token')
ALICE_ID=$(echo $ALICE_RESP | jq -r '.user.id')

if [ "$ALICE_TOKEN" != "null" ]; then
    echo -e "${GREEN}‚úÖ Alice Logged In (ID: $ALICE_ID)${NC}"
else
    echo -e "${RED}‚ùå Alice Login Failed${NC}"
    exit 1
fi

# --- BOB ---
echo "1b. Creating & Logging in User 'Bob'..."
curl -s -X POST "$BASE_URL/auth/signup" \
  -H "$CONTENT_HEADER" \
  -d '{
    "username": "bob_test", "password": "StrongPass123",
    "firstName": "Bob", "lastName": "Builder",
    "email": "bob_test@example.com", "shippingAddress": "456 Builder Ln"
  }' > /dev/null

BOB_RESP=$(curl -s -X POST "$BASE_URL/auth/signin" \
  -H "$CONTENT_HEADER" \
  -d '{ "username": "bob_test", "password": "StrongPass123" }')

BOB_TOKEN=$(echo $BOB_RESP | jq -r '.token')
BOB_ID=$(echo $BOB_RESP | jq -r '.user.id')

if [ "$BOB_TOKEN" != "null" ]; then
    echo -e "${GREEN}‚úÖ Bob Logged In (ID: $BOB_ID)${NC}"
else
    echo -e "${RED}‚ùå Bob Login Failed${NC}"
    exit 1
fi


# ==========================================
# 2. FORWARD AUCTION TESTING
# ==========================================
echo " "
echo "--- Test 2: Forward Auction Flow ---"

echo "2a. Alice creates a Forward Auction (Vintage Lamp)..."
FWD_AUCTION_ID=$(curl -s -X POST "$BASE_URL/auctions/create" \
  -H "$CONTENT_HEADER" \
  -H "Authorization: Bearer $ALICE_TOKEN" \
  -d '{
      "title": "Vintage Lamp", "description": "Old Lamp",
      "startingPrice": 50.00, "durationMinutes": 60,
      "type": "Home", "auctionType": "FORWARD",
      "seller": "alice_test"
    }' | jq -r '.id')

echo -e "${GREEN}‚úÖ Created Forward Auction ID: $FWD_AUCTION_ID${NC}"

echo "2b. Bob places a LOW bid ($40)..."
LOW_BID_RESP=$(curl -s -w "%{http_code}" -o /dev/null -X POST "$BASE_URL/bids/place" \
  -H "$CONTENT_HEADER" \
  -H "Authorization: Bearer $BOB_TOKEN" \
  -d "{\"auctionId\": $FWD_AUCTION_ID, \"userId\": $BOB_ID, \"bidAmount\": 40.00}")

if [ "$LOW_BID_RESP" -eq 400 ]; then
    echo -e "${GREEN}‚úÖ Server correctly rejected low bid (400 Bad Request)${NC}"
else
    echo -e "${RED}‚ùå Failed: Server accepted low bid (Code: $LOW_BID_RESP)${NC}"
fi

echo "2c. Bob places a VALID bid ($60)..."
VALID_BID_RESP=$(curl -s -w "%{http_code}" -o /dev/null -X POST "$BASE_URL/bids/place" \
  -H "$CONTENT_HEADER" \
  -H "Authorization: Bearer $BOB_TOKEN" \
  -d "{\"auctionId\": $FWD_AUCTION_ID, \"userId\": $BOB_ID, \"bidAmount\": 60.00}")

if [ "$VALID_BID_RESP" -eq 200 ]; then
    echo -e "${GREEN}‚úÖ Bid Accepted (200 OK)${NC}"
else
    echo -e "${RED}‚ùå Bid Failed (Code: $VALID_BID_RESP)${NC}"
fi


# ==========================================
# 3. DUTCH AUCTION TESTING 
# ==========================================
echo " "
echo "--- Test 3: Dutch Auction Flow ---"

echo "3a. Alice creates a Dutch Auction (Gaming Laptop)..."
# Note: Includes minPrice and decreaseAmount
DUTCH_ID=$(curl -s -X POST "$BASE_URL/auctions/create" \
  -H "$CONTENT_HEADER" \
  -H "Authorization: Bearer $ALICE_TOKEN" \
  -d '{
      "title": "Gaming Laptop", "description": "Fast Laptop",
      "startingPrice": 2000.00, "durationMinutes": 120,
      "type": "Electronics", "auctionType": "DUTCH",
      "minPrice": 1000.00, "decreaseAmount": 50.00, "decreaseIntervalSeconds": 30,
      "seller": "alice_test"
    }' | jq -r '.id')

echo -e "${GREEN}‚úÖ Created Dutch Auction ID: $DUTCH_ID${NC}"

echo "3b. Bob buys INSTANTLY (Buy Now / Bid 0)..."
# Dutch logic treats 0.00 or current price as a buy command
BUY_NOW_RESP=$(curl -s -w "%{http_code}" -o /dev/null -X POST "$BASE_URL/bids/place" \
  -H "$CONTENT_HEADER" \
  -H "Authorization: Bearer $BOB_TOKEN" \
  -d "{\"auctionId\": $DUTCH_ID, \"userId\": $BOB_ID, \"bidAmount\": 0.00}")

if [ "$BUY_NOW_RESP" -eq 200 ]; then
    echo -e "${GREEN}‚úÖ Dutch Buy Successful (200 OK)${NC}"
else
    echo -e "${RED}‚ùå Dutch Buy Failed (Code: $BUY_NOW_RESP)${NC}"
fi


# ==========================================
# 4. EDGE CASES & FAILURE SCENARIOS
# ==========================================
echo " "
echo "--- Test 4: Edge Cases ---"

echo "4a. Alice tries to buy the ALREADY SOLD Dutch item..."
SOLD_RESP=$(curl -s -w "%{http_code}" -o /dev/null -X POST "$BASE_URL/bids/place" \
  -H "$CONTENT_HEADER" \
  -H "Authorization: Bearer $ALICE_TOKEN" \
  -d "{\"auctionId\": $DUTCH_ID, \"userId\": $ALICE_ID, \"bidAmount\": 0.00}")

if [ "$SOLD_RESP" -eq 400 ]; then
    echo -e "${GREEN}‚úÖ Blocked: Cannot bid on closed item (400 Bad Request)${NC}"
else
    echo -e "${RED}‚ùå Failed: System allowed bid on sold item (Code: $SOLD_RESP)${NC}"
fi

echo "4b. Bidding on Non-Existent Auction (ID 99999)..."
GHOST_RESP=$(curl -s -w "%{http_code}" -o /dev/null -X POST "$BASE_URL/bids/place" \
  -H "$CONTENT_HEADER" \
  -H "Authorization: Bearer $BOB_TOKEN" \
  -d "{\"auctionId\": 99999, \"userId\": $BOB_ID, \"bidAmount\": 100.00}")

if [ "$GHOST_RESP" -eq 400 ]; then
    echo -e "${GREEN}‚úÖ Blocked: Auction not found (400 Bad Request)${NC}"
else
    echo -e "${RED}‚ùå Failed: Unexpected response code $GHOST_RESP${NC}"
fi

echo "4c. Creating Auction with Invalid Data (Negative Price)..."
INVALID_RESP=$(curl -s -w "%{http_code}" -o /dev/null -X POST "$BASE_URL/auctions/create" \
  -H "$CONTENT_HEADER" \
  -H "Authorization: Bearer $ALICE_TOKEN" \
  -d '{
      "title": "Bad Item", "description": "Desc",
      "startingPrice": -50.00, "durationMinutes": 60,
      "type": "Home", "auctionType": "FORWARD"
    }')

if [ "$INVALID_RESP" -eq 400 ]; then
    echo -e "${GREEN}‚úÖ Blocked: Negative price rejected (400 Bad Request)${NC}"
else
    echo -e "${RED}‚ùå Failed: Negative price accepted (Code: $INVALID_RESP)${NC}"
fi

# ==========================================
# 5. FINAL CHECK
# ==========================================
echo " "
echo "--- Test 5: Final State ---"
echo "Checking Item Status via Catalogue API..."

# Fetch active items to verify visibility
ACTIVE_ITEMS=$(curl -s -X GET "$BASE_URL/catalogue/active")
# Check if Dutch item (ID $DUTCH_ID) is marked as closed
IS_CLOSED=$(echo $ACTIVE_ITEMS | jq ".[] | select(.id==$DUTCH_ID) | .closed")

if [ "$IS_CLOSED" == "true" ]; then
    echo -e "${GREEN}‚úÖ Dutch Item verified as CLOSED in Database${NC}"
else
    echo -e "${RED}‚ùå Dutch Item is still OPEN (Should be closed)${NC}"
fi

echo " "
echo "--- üèÅ All Tests Complete ---"