# Set the base URL for your API
BASE_URL="http://localhost:8080/api"

echo "--- 1. Setting up Users ---"

# Create Alice
# The User class requires: username, password, firstName, lastName, shippingAddress, email.
# The 'jq -r .id' part extracts the "id" field from the JSON response
USER_ID_ALICE=$(curl -s -X POST "$BASE_URL/users" \
     -H "Content-Type: application/json" \
     -d '{"username": "alice", "password": "pass", "firstName": "Alice", "lastName": "Wonderland", "shippingAddress": "1 Road", "email": "alice@example.com"}' | jq -r .id)

# Create Bob
USER_ID_BOB=$(curl -s -X POST "$BASE_URL/users" \
     -H "Content-Type: application/json" \
     -d '{"username": "bob", "password": "pass", "firstName": "Bob", "lastName": "TheBuilder", "shippingAddress": "2 Street", "email": "bob@example.com"}' | jq -r .id)

echo "Alice created with ID: $USER_ID_ALICE"
echo "Bob created with ID: $USER_ID_BOB"
echo "---------------------------"

# ---
# Test 1: Auction Accepts Valid Bids
# ---
echo "\n--- Test 1: Auction Accepts Valid Bids ---"
# Create a new auction. The AuctionClass requires 'itemName', 'startingPrice', and 'endTime'.
# We calculate endTime manually here (5 minutes from now) for the curl command.
# NOTE: You may want to create a DTO in your API that accepts 'durationInMinutes'
# and calculates 'endTime' on the server. I will use a simple fixed time for now.
END_TIME_1=$(date -v +5M +"%Y-%m-%dT%H:%M:%S")
echo "Auction End Time set to: $END_TIME_1"

AUCTION_ID_1=$(curl -s -X POST "$BASE_URL/auctions" \
     -H "Content-Type: application/json" \
     -d "{\"itemName\": \"Painting\", \"startingPrice\": 100.00, \"endTime\": \"$END_TIME_1\"}" | jq -r .id)
echo "Created 'Painting' auction with ID: $AUCTION_ID_1"

echo "Alice placing bid of 120..."
curl -s -X POST "$BASE_URL/bids" \
     -H "Content-Type: application/json" \
     -d "{\"auctionId\": $AUCTION_ID_1, \"userId\": $USER_ID_ALICE, \"bidAmount\": 120.00}"
echo "" # new line

echo "Bob placing bid of 150..."
curl -s -X POST "$BASE_URL/bids" \
     -H "Content-Type: application/json" \
     -d "{\"auctionId\": $AUCTION_ID_1, \"userId\": $USER_ID_BOB, \"bidAmount\": 150.00}"
echo "" # new line

# Verify the auction status
echo "Verifying auction status..."
curl -s -X GET "$BASE_URL/auctions/$AUCTION_ID_1" | jq .

# ---
# Test 2: Auction Rejects Bid from Non-Existent User
# ---
echo "\n--- Test 2: Auction Rejects Bid from Non-Existent User ---"
END_TIME_2=$(date -v +5M +"%Y-%m-%dT%H:%M:%S")
AUCTION_ID_2=$(curl -s -X POST "$BASE_URL/auctions" \
     -H "Content-Type: application/json" \
     -d "{\"itemName\": \"Laptop\", \"startingPrice\": 200.00, \"endTime\": \"$END_TIME_2\"}" | jq -r .id)
echo "Created 'Laptop' auction with ID: $AUCTION_ID_2"


echo "Placing bid with non-existent User ID 999..."
curl -i -X POST "$BASE_URL/bids" \
     -H "Content-Type: application/json" \
     -d "{\"auctionId\": $AUCTION_ID_2, \"userId\": 999, \"bidAmount\": 250.00}"

# ---
# Test 3 & 4: Auction Closes and Rejects Bids
# ---
echo "\n--- Test 3 & 4: Auction Closes and Rejects Bids ---"
# Set a short end time (1 minute from now)
END_TIME_3=$(date -v +1M +"%Y-%m-%dT%H:%M:%S")

AUCTION_ID_3=$(curl -s -X POST "$BASE_URL/auctions" \
     -H "Content-Type: application/json" \
     -d "{\"itemName\": \"Watch\", \"startingPrice\": 300.00, \"endTime\": \"$END_TIME_3\"}" | jq -r .id)
echo "Created 'Watch' auction (ID: $AUCTION_ID_3) with end time: $END_TIME_3"


echo "Bob placing bid of 400..."
curl -s -X POST "$BASE_URL/bids" \
     -H "Content-Type: application/json" \
     -d "{\"auctionId\": $AUCTION_ID_3, \"userId\": $USER_ID_BOB, \"bidAmount\": 400.00}"
echo "" # new line

# Wait for the auction to close. You need a scheduling task on the server to handle this.
echo "Waiting 70 seconds for auction to close automatically..."
sleep 70

# Check the auction status
echo "Verifying auction status..."
curl -s -X GET "$BASE_URL/auctions/$AUCTION_ID_3" | jq .

# (Test 4) Try to place a bid on the closed auction 
echo "Alice attempting to bid 500 on closed auction..."
curl -i -X POST "$BASE_URL/bids" \
     -H "Content-Type: application/json" \
     -d "{\"auctionId\": $AUCTION_ID_3, \"userId\": $USER_ID_ALICE, \"bidAmount\": 500.00}"

echo "\n--- Tests Complete ---"