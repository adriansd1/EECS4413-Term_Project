#!/bin/bash

# A script to run end-to-end tests on the auction system
# Make sure your Spring Boot application is running!

BASE_URL="http://localhost:8080"
JSON_HEADER="Content-Type: application/json"

echo "--- ðŸš€ Starting Auction System Test ---"

# --- 1. User Creation ---
echo " "
echo "--- Test 1: Creating Users ---"

echo "Creating User 'Alice'..."
# We use 'jq -r .id' to extract the 'id' field from the JSON response and save it
USER_ID_ALICE=$(curl -s -X POST "$BASE_URL/api/users" \
  -H "$JSON_HEADER" \
  -d '{
      "username": "alice_in_wonder", "password": "password123",
      "firstName": "Alice", "lastName": "Smith",
      "shippingAddress": "123 Wonderland Ave", "email": "alice@example.com"
    }' | jq -r '.id')

echo "âœ… Created Alice with ID: $USER_ID_ALICE"


echo "Creating User 'Bob'..."
USER_ID_BOB=$(curl -s -X POST "$BASE_URL/api/users" \
  -H "$JSON_HEADER" \
  -d '{
      "username": "bob_the_bidder", "password": "password456",
      "firstName": "Bob", "lastName": "Johnson",
      "shippingAddress": "456 Bidder St", "email": "bob@example.com"
    }' | jq -r '.id')

echo "âœ… Created Bob with ID: $USER_ID_BOB"

# --- 2. Auction Creation ---
echo " "
echo "--- Test 2: Creating Auction ---"
echo "Creating Auction 'Antique Lamp'..."
AUCTION_ID=$(curl -s -X POST "$BASE_URL/api/auctions" \
  -H "$JSON_HEADER" \
  -d '{
      "itemName": "Antique Lamp",
      "startingPrice": 50.00,
      "durationInMinutes": 30
    }' | jq -r '.id')

echo "âœ… Created Auction with ID: $AUCTION_ID"

# --- 3. Bidding Logic Tests ---
echo " "
echo "--- Test 3: Bidding Logic ---"
echo "Test 3a: Alice (ID $USER_ID_ALICE) places first valid bid ($55.00)..."
curl -s -X POST "$BASE_URL/api/bids/place" \
  -H "$JSON_HEADER" \
  -d '{
      "auctionId": '$AUCTION_ID',
      "userId": '$USER_ID_ALICE',
      "bidAmount": 55.00
    }'
echo "" # Adds a newline

echo "Test 3b: Bob (ID $USER_ID_BOB) places a bid that is too low ($52.00)..."
echo "EXPECTED: 400 Bad Request (Bid was not high enough...)"
curl -v -X POST "$BASE_URL/api/bids/place" \
  -H "$JSON_HEADER" \
  -d '{
      "auctionId": '$AUCTION_ID',
      "userId": '$USER_ID_BOB',
      "bidAmount": 52.00
    }'
echo ""

echo "Test 3c: Bob (ID $USER_ID_BOB) places a valid high bid ($60.00)..."
echo "EXPECTED: 200 OK (Bid placed successfully!)"
curl -v -X POST "$BASE_URL/api/bids/place" \
  -H "$JSON_HEADER" \
  -d '{
      "auctionId": '$AUCTION_ID',
      "userId": '$USER_ID_BOB',
      "bidAmount": 60.00
    }'
echo ""

# --- 4. 'Not Found' Logic Tests ---
echo " "
echo "--- Test 4: 'Not Found' (404) Logic ---"
echo "Test 4a: Bidding on a non-existent auction (ID 9999)..."
echo "EXPECTED: 404 Not Found"
curl -v -X POST "$BASE_URL/api/bids/place" \
  -H "$JSON_HEADER" \
  -d '{
      "auctionId": 9999,
      "userId": '$USER_ID_ALICE',
      "bidAmount": 100.00
    }'
echo ""

echo "Test 4b: Bidding with a non-existent user (ID 9999)..."
echo "EXPECTED: 404 Not Found"
curl -v -X POST "$BASE_URL/api/bids/place" \
  -H "$JSON_HEADER" \
  -d '{
      "auctionId": '$AUCTION_ID',
      "userId": 9999,
      "bidAmount": 100.00
    }'
echo ""

# --- 5. Final State Check ---
echo " "
echo "--- Test 5: Final Database State ---"
echo "Fetching all users..."
curl -s -X GET "$BASE_URL/api/users" | jq
echo ""

echo "Fetching all auctions..."
curl -s -X GET "$BASE_URL/api/auctions" | jq
echo ""

echo "--- âœ… Test Complete ---"