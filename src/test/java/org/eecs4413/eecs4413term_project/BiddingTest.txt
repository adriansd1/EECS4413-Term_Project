#!/bin/bash
# A script to run end-to-end tests on the auction system.
# Make sure your Spring Boot application is running at http://localhost:8080
# ==========================================
#  AUCTION SYSTEM E2E TEST SCRIPT
# ==========================================


BASE_URL="http://localhost:8080/api"
CONTENT_HEADER="Content-Type: application/json"

JSON_HEADER="Content-Type: application/json"

echo "--- 1. Setting up Users & Auction ---"

# User Creation (matches your UserController DTO)
USER_ID_ALICE=$(curl -s -X POST "$BASE_URL/users" \
     -H "$JSON_HEADER" \
     -d '{"username": "alice", "password": "pass", "firstName": "Alice", "lastName": "A", "shippingAddress": "1 Road", "email": "a@example.com"}' | jq -r .id)

USER_ID_BOB=$(curl -s -X POST "$BASE_URL/users" \
     -H "$JSON_HEADER" \
     -d '{"username": "bob", "password": "pass", "firstName": "Bob", "lastName": "B", "shippingAddress": "2 Street", "email": "b@example.com"}' | jq -r .id)

USER_ID_CHARLIE=$(curl -s -X POST "$BASE_URL/users" \
     -H "$JSON_HEADER" \
     -d '{"username": "charlie", "password": "pass", "firstName": "Charlie", "lastName": "C", "shippingAddress": "3 Avenue", "email": "c@example.com"}' | jq -r .id)

echo "Alice (ID: $USER_ID_ALICE), Bob (ID: $USER_ID_BOB), Charlie (ID: $USER_ID_CHARLIE) created."

# Auction Creation (uses 'durationInMinutes' as required by your AuctionController)
AUCTION_ID=$(curl -s -X POST "$BASE_URL/auctions" \
     -H "$JSON_HEADER" \
     -d "{\"itemName\": \"Antique Vase\", \"startingPrice\": 100.00, \"durationInMinutes\": 10}" | jq -r .id)

echo "Created 'Antique Vase' auction (ID: $AUCTION_ID) lasting 10 minutes."
echo "---------------------------"

# ---
# Test 1: Authenticated User Can Bid (First Bid)
# ---
echo -e "\n--- Test 1: Authenticated User Can Place First Bid ---"
echo "Alice (valid user) placing first bid of 150.00..."

# NOTE: Endpoint is /api/bids/place
curl -v -X POST "$BASE_URL/bids/place" \
     -H "$JSON_HEADER" \
     -d "{\"auctionId\": $AUCTION_ID, \"userId\": $USER_ID_ALICE, \"bidAmount\": 150.00}"
# EXPECTED: HTTP/1.1 200 OK AND "Bid placed successfully!"

# ---
# Test 2: Higher Bid is Accepted
# ---
echo -e "\n--- Test 2: Authenticated User Can Place HIGHER Bid ---"
echo "Bob (valid user) placing higher bid of 175.50..."

curl -v -X POST "$BASE_URL/bids/place" \
     -H "$JSON_HEADER" \
     -d "{\"auctionId\": $AUCTION_ID, \"userId\": $USER_ID_BOB, \"bidAmount\": 175.50}"
# EXPECTED: HTTP/1.1 200 OK AND "Bid placed successfully!"

# ---
# Test 3: Lower Bid is Rejected
# ---
echo -e "\n--- Test 3: Authenticated User's LOWER Bid is Rejected ---"
echo "Charlie (valid user) placing lower bid of 120.00 (Current high bid is 175.50)..."
curl -v -X POST "$BASE_URL/bids/place" \
     -H "$JSON_HEADER" \
     -d "{\"auctionId\": $AUCTION_ID, \"userId\": $USER_ID_CHARLIE, \"bidAmount\": 120.00}"
# EXPECTED: HTTP/1.1 400 Bad Request AND "Bid was not high enough..."

# ---
# Test 4: Unauthenticated (Non-Existent) User is Rejected
# ---
echo -e "\n--- Test 4: Unauthenticated (Non-Existent) User is Rejected ---"
echo "Placing bid with non-existent User ID 9999..."
curl -v -X POST "$BASE_URL/bids/place" \
     -H "$JSON_HEADER" \
     -d "{\"auctionId\": $AUCTION_ID, \"userId\": 9999, \"bidAmount\": 200.00}"
# EXPECTED: HTTP/1.1 404 Not Found (from the try/catch in BiddingController)

echo "---------------------------"

echo "Fetching all users..."
# If secured: -H "Authorization: Bearer $ALICE_TOKEN"
curl -s -X GET "$BASE_URL/users" | jq
echo ""

echo "Fetching all auctions..."
# Assuming /api/catalogue/active or similar is public, or use /api/catalogue if authenticated
curl -s -X GET "$BASE_URL/catalogue/active" | jq
echo ""

echo "Fetching all bids for Auction ID $FWD_AUCTION_ID (EXPECTS 2 bids: 150.00 and 175.50)..."
curl -s -X GET "$BASE_URL/bids?auctionId=$FWD_AUCTION_ID" | jq
echo ""

echo "Fetching all bids for User ID $ALICE_ID (Alice - EXPECTS 1 bid on Vase)..."
curl -s -X GET "$BASE_URL/bids?userId=$ALICE_ID" | jq
echo ""

echo "Fetching all bids for User ID $CHARLIE_ID (Charlie - EXPECTS 0 valid bids)..."
curl -s -X GET "$BASE_URL/bids?userId=$CHARLIE_ID" | jq
echo ""

# Note: Dutch auction winning "bid" is also stored in bids table
echo "Fetching all bids in the system (EXPECTS 3 total: 2 on Vase, 1 on Laptop)..."
curl -s -X GET "$BASE_URL/bids" | jq
echo ""

echo "--- âœ… Bidding Logic Tests Complete ---"